{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ customer_name }}{% endblock %}
{% block breadcrumb %}Customers / {{ customer_name }}{% endblock %}

{% block content %}

<!-- ── HEADER ── -->
<div class="detail-header">
  <div class="detail-header-left">
    <a href="{% url 'dashboard:customers_list' %}" class="back-link">← Back to Customers</a>
    <h2 class="detail-title">{{ customer_name }}
      {% if is_blocked %}<span style="font-size:0.9rem;color:var(--error);">Blocked</span>{% endif %}
    </h2>
    <span class="detail-date">{{ email }}</span>
  </div>
  <div class="detail-header-right">
    {% if is_blocked %}
      <form method="POST" action="{% url 'dashboard:customer_unblock' email %}">
        {% csrf_token %}
        <button type="submit" class="btn-advance" style="background:var(--success);">✓ Unblock Customer</button>
      </form>
    {% else %}
      <button onclick="document.getElementById('blockForm').style.display='block';this.style.display='none';"
              class="btn-cancel-order">Block Customer</button>
    {% endif %}
  </div>
</div>

<!-- Block form (hidden by default) -->
{% if not is_blocked %}
  <div id="blockForm" style="display:none;" class="dash-card" style="margin-bottom:1rem;">
    <div class="dash-card-header"><span class="dash-card-title">Block Customer</span></div>
    <div class="form-body">
      <form method="POST" action="{% url 'dashboard:customer_block' email %}">
        {% csrf_token %}
        <div class="form-field">
          <label class="form-label">Reason (optional)</label>
          <input type="text" name="reason" placeholder="e.g. No-show, fraud, abusive..." class="form-input">
        </div>
        <div style="display:flex;gap:0.8rem;">
          <button type="submit" class="btn-cancel-order">Confirm Block</button>
          <button type="button" onclick="document.getElementById('blockForm').style.display='none';" class="btn-outline">Cancel</button>
        </div>
      </form>
    </div>
  </div>
{% endif %}

<!-- ── STATS ROW ── -->
<div class="stat-grid" style="margin-bottom:1.5rem;">
  <div class="stat-card stat-primary">
    <div class="stat-label">Total Spent</div>
    <div class="stat-value">${{ total_spent|floatformat:2 }}</div>
    <div class="stat-sub">confirmed orders only</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Orders</div>
    <div class="stat-value">{{ order_count }}</div>
    <div class="stat-sub">completed</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Reservations</div>
    <div class="stat-value">{{ reservations|length }}</div>
    <div class="stat-sub">all time</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Phone</div>
    <div class="stat-value" style="font-size:1rem;">{{ customer_phone }}</div>
    <div class="stat-sub">from latest order</div>
  </div>
</div>

<!-- ── ORDERS + RESERVATIONS ── -->
<div class="detail-grid">

  <!-- Orders -->
  <div class="dash-card">
    <div class="dash-card-header">
      <span class="dash-card-title">Order History</span>
      <span class="dash-card-title" style="color:var(--mid);font-size:0.68rem;">{{ orders|length }} order{{ orders|length|pluralize }}</span>
    </div>

    {% if orders %}
      <div class="orders-table-wrap">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order #</th>
              <th>Items</th>
              <th>Total</th>
              <th>Pickup</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
              <tr>
                <td>
                  <a href="{% url 'dashboard:order_detail' order.id %}" class="tbl-btn">
                    #{{ order.order_number|stringformat:"s"|slice:":8"|upper }}
                  </a>
                </td>
                <td class="items-cell">{{ order.items.count }} item{{ order.items.count|pluralize }}</td>
                <td class="total-cell">${{ order.total }}</td>
                <td class="pickup-cell">{{ order.pickup_time|date:"M j" }} {{ order.pickup_time|time:"g:i A" }}</td>
                <td><span class="status-pill status-{{ order.status }}">{{ order.get_status_display }}</span></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="dash-empty">No orders found.</div>
    {% endif %}
  </div>

  <!-- Reservations -->
  <div class="dash-card">
    <div class="dash-card-header">
      <span class="dash-card-title">Reservation History</span>
      <span class="dash-card-title" style="color:var(--mid);font-size:0.68rem;">{{ reservations|length }} booking{{ reservations|length|pluralize }}</span>
    </div>

    {% if reservations %}
      <div class="orders-table-wrap">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Guests</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for res in reservations %}
              <tr>
                <td class="customer-name">{{ res.date|date:"M j, Y" }}</td>
                <td class="items-cell">{{ res.time|time:"g:i A" }}</td>
                <td class="items-cell">{{ res.number_of_guests }}</td>
                <td><span class="status-pill status-{{ res.status }}">{{ res.get_status_display }}</span></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="dash-empty">No reservations found.</div>
    {% endif %}
  </div>

</div>

{% endblock %}