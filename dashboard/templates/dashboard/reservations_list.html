{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Reservations{% endblock %}
{% block breadcrumb %}Reservations{% endblock %}

{% block content %}

<!-- ── TOP STATS ── -->
<div class="stat-grid" style="margin-bottom:1.5rem;">
  <div class="stat-card stat-alert">
    <div class="stat-label">Pending Approval</div>
    <div class="stat-value">{{ counts.pending }}</div>
    <div class="stat-sub">need a response</div>
  </div>
  <div class="stat-card stat-primary">
    <div class="stat-label">Today</div>
    <div class="stat-value">{{ today_count }}</div>
    <div class="stat-sub">reservation{{ today_count|pluralize }} today</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Upcoming</div>
    <div class="stat-value">{{ upcoming_count }}</div>
    <div class="stat-sub">confirmed future bookings</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total</div>
    <div class="stat-value">{{ counts.all }}</div>
    <div class="stat-sub">all time</div>
  </div>
</div>

<!-- ── MAIN CARD ── -->
<div class="dash-card">
  <div class="dash-card-header">
    <span class="dash-card-title">All Reservations</span>
    <span class="dash-card-title" style="color:var(--mid);font-size:0.68rem;">{{ reservations|length }} result{{ reservations|length|pluralize }}</span>
  </div>

  <!-- Status tabs -->
  <div class="status-tabs">
    <a href="{% url 'dashboard:reservations_list' %}{% if date_filter %}?date={{ date_filter }}{% endif %}"
       class="status-tab {% if not status_filter %}active{% endif %}">
      All <span class="tab-count">{{ counts.all }}</span>
    </a>
    <a href="?status=pending{% if date_filter %}&date={{ date_filter }}{% endif %}"
       class="status-tab {% if status_filter == 'pending' %}active{% endif %}">
      Pending <span class="tab-count">{{ counts.pending }}</span>
    </a>
    <a href="?status=confirmed{% if date_filter %}&date={{ date_filter }}{% endif %}"
       class="status-tab {% if status_filter == 'confirmed' %}active{% endif %}">
      Confirmed <span class="tab-count">{{ counts.confirmed }}</span>
    </a>
    <a href="?status=cancelled{% if date_filter %}&date={{ date_filter }}{% endif %}"
       class="status-tab {% if status_filter == 'cancelled' %}active{% endif %}">
      Cancelled <span class="tab-count">{{ counts.cancelled }}</span>
    </a>
  </div>

  <!-- Search + date filter -->
  <div class="filter-bar">
    <form method="GET" class="filter-form">
      {% if status_filter %}
        <input type="hidden" name="status" value="{{ status_filter }}">
      {% endif %}
      <input type="text" name="search" placeholder="Search name, email, phone..." value="{{ search }}" class="filter-input">
      <input type="date" name="date" value="{{ date_filter }}" class="filter-input filter-date">
      <button type="submit" class="filter-btn">Filter</button>
      {% if search or date_filter %}
        <a href="?{% if status_filter %}status={{ status_filter }}{% endif %}" class="filter-clear">Clear</a>
      {% endif %}
    </form>
  </div>

  <!-- Reservations table -->
  {% if reservations %}
    <div class="orders-table-wrap">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Guest</th>
            <th>Date & Time</th>
            <th>Guests</th>
            <th>Occasion</th>
            <th>Booked</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for res in reservations %}
            <tr>
              <td>
                <div class="customer-cell">
                  <span class="customer-name">{{ res.name }}</span>
                  <span class="customer-email">{{ res.email }}</span>
                </div>
              </td>
              <td>
                <div class="customer-cell">
                  <span class="customer-name">{{ res.date|date:"M j, Y" }}</span>
                  <span class="customer-email">{{ res.time|time:"g:i A" }}</span>
                </div>
              </td>
              <td class="items-cell">{{ res.number_of_guests }} guest{{ res.number_of_guests|pluralize }}</td>
              <td class="items-cell">{{ res.occasion|default:"—" }}</td>
              <td class="pickup-cell">{{ res.created_at|date:"M j, g:i A" }}</td>
              <td>
                <span class="status-pill status-{{ res.status }}">{{ res.get_status_display }}</span>
              </td>
              <td>
                {% if res.status == 'pending' %}
                  <div style="display:flex;gap:0.4rem;">
                    <form method="POST" action="{% url 'dashboard:reservation_approve' res.id %}">
                      {% csrf_token %}
                      <button type="submit" class="quick-approve">✓</button>
                    </form>
                    <form method="POST" action="{% url 'dashboard:reservation_reject' res.id %}"
                          onsubmit="return confirm('Reject this reservation?')">
                      {% csrf_token %}
                      <button type="submit" class="quick-reject">✕</button>
                    </form>
                    <a href="{% url 'dashboard:reservation_detail' res.id %}" class="tbl-btn">View</a>
                  </div>
                {% else %}
                  <a href="{% url 'dashboard:reservation_detail' res.id %}" class="tbl-btn">View →</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="dash-empty">No reservations found{% if search %} for "{{ search }}"{% endif %}.</div>
  {% endif %}

</div>

{% endblock %}