{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Order #{{ order.order_number|stringformat:"s"|slice:":8"|upper }}{% endblock %}
{% block breadcrumb %}Orders / #{{ order.order_number|stringformat:"s"|slice:":8"|upper }}{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ HEADER ROW ‚îÄ‚îÄ -->
<div class="detail-header">
  <div class="detail-header-left">
    <a href="{% url 'dashboard:orders_list' %}" class="back-link">‚Üê Back to Orders</a>
    <h2 class="detail-title">Order <span>#{{ order.order_number|stringformat:"s"|slice:":8"|upper }}</span></h2>
    <span class="detail-date">Placed {{ order.created_at|date:"F j, Y" }} at {{ order.created_at|time:"g:i A" }}</span>
  </div>
  <div class="detail-header-right">
    <span class="status-pill status-{{ order.status }} status-lg">{{ order.get_status_display }}</span>
    <a href="{% url 'dashboard:order_print' order.id %}" target="_blank" class="btn-outline">üñ® Print Receipt</a>
  </div>
</div>

<!-- ‚îÄ‚îÄ STATUS PROGRESS BAR ‚îÄ‚îÄ -->
<div class="dash-card" style="margin-bottom:1rem;">
  <div class="status-progress">
    <div class="progress-steps">
      <div class="progress-step {% if order.status == 'pending' %}active{% elif order.status != 'cancelled' %}done{% endif %}">
        <div class="step-dot"></div>
        <div class="step-label">Pending</div>
      </div>
      <div class="progress-line {% if order.status not in 'pending,cancelled' %}done{% endif %}"></div>
      <div class="progress-step {% if order.status == 'confirmed' %}active{% elif order.status in 'preparing,ready,completed' %}done{% endif %}">
        <div class="step-dot"></div>
        <div class="step-label">Confirmed</div>
      </div>
      <div class="progress-line {% if order.status in 'preparing,ready,completed' %}done{% endif %}"></div>
      <div class="progress-step {% if order.status == 'preparing' %}active{% elif order.status in 'ready,completed' %}done{% endif %}">
        <div class="step-dot"></div>
        <div class="step-label">Preparing</div>
      </div>
      <div class="progress-line {% if order.status in 'ready,completed' %}done{% endif %}"></div>
      <div class="progress-step {% if order.status == 'ready' %}active{% elif order.status == 'completed' %}done{% endif %}">
        <div class="step-dot"></div>
        <div class="step-label">Ready</div>
      </div>
      <div class="progress-line {% if order.status == 'completed' %}done{% endif %}"></div>
      <div class="progress-step {% if order.status == 'completed' %}active done{% endif %}">
        <div class="step-dot"></div>
        <div class="step-label">Completed</div>
      </div>
    </div>
  </div>

  <!-- Action buttons -->
  {% if order.status != 'cancelled' and order.status != 'completed' %}
    <div class="status-actions">
      {% if next_status %}
        <form method="POST" action="{% url 'dashboard:order_update_status' order.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn-advance">
            Mark as {{ next_status_label }} ‚Üí
          </button>
        </form>
      {% endif %}
      <form method="POST" action="{% url 'dashboard:order_cancel' order.id %}"
            onsubmit="return confirm('Cancel this order? This cannot be undone.')">
        {% csrf_token %}
        <button type="submit" class="btn-cancel-order">Cancel Order</button>
      </form>
    </div>
  {% endif %}
</div>

<!-- ‚îÄ‚îÄ DETAIL GRID ‚îÄ‚îÄ -->
<div class="detail-grid">

  <!-- Left: Order items -->
  <div class="dash-card">
    <div class="dash-card-header">
      <span class="dash-card-title">Items Ordered</span>
      <span class="dash-card-title" style="color:var(--mid);">{{ order.items.count }} item{{ order.items.count|pluralize }}</span>
    </div>
    <div style="padding:0;">
      {% for item in order.items.all %}
        <div class="detail-item-row">
          <div class="detail-item-info">
            <span class="detail-item-qty">{{ item.quantity }}√ó</span>
            <div>
              <span class="detail-item-name">{{ item.name }}</span>
              {% if item.addons %}
                <span class="detail-item-addons">+ {{ item.addons }}</span>
              {% endif %}
            </div>
          </div>
          <span class="detail-item-price">${{ item.item_total }}</span>
        </div>
      {% endfor %}

      <!-- Totals -->
      <div class="detail-totals">
        {% if order.discount_amount %}
          <div class="detail-total-row">
            <span>Subtotal</span>
            <span>${{ order.total|add:order.discount_amount }}</span>
          </div>
          <div class="detail-total-row discount">
            <span>Discount ({{ order.promo_code }})</span>
            <span>‚àí${{ order.discount_amount }}</span>
          </div>
        {% endif %}
        <div class="detail-total-row grand">
          <span>Total Paid</span>
          <span>${{ order.total }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Customer + pickup info -->
  <div style="display:flex;flex-direction:column;gap:1rem;">

    <!-- Customer info -->
    <div class="dash-card">
      <div class="dash-card-header">
        <span class="dash-card-title">Customer</span>
      </div>
      <div class="info-rows">
        <div class="info-row">
          <span class="info-label">Name</span>
          <span class="info-value">{{ order.name }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value">
            <a href="mailto:{{ order.email }}" class="info-link">{{ order.email }}</a>
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Phone</span>
          <span class="info-value">
            <a href="tel:{{ order.phone }}" class="info-link">{{ order.phone }}</a>
          </span>
        </div>
      </div>
    </div>

    <!-- Pickup info -->
    <div class="dash-card">
      <div class="dash-card-header">
        <span class="dash-card-title">Pickup Details</span>
      </div>
      <div class="info-rows">
        <div class="info-row">
          <span class="info-label">Date</span>
          <span class="info-value">{{ order.pickup_time|date:"F j, Y" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Time</span>
          <span class="info-value pickup-time-highlight">{{ order.pickup_time|time:"g:i A" }}</span>
        </div>
        {% if order.order_notes %}
          <div class="info-row">
            <span class="info-label">Notes</span>
            <span class="info-value">{{ order.order_notes }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Payment info -->
    <div class="dash-card">
      <div class="dash-card-header">
        <span class="dash-card-title">Payment</span>
      </div>
      <div class="info-rows">
        <div class="info-row">
          <span class="info-label">Method</span>
          <span class="info-value">Stripe</span>
        </div>
        <div class="info-row">
          <span class="info-label">Status</span>
          <span class="info-value" style="color:var(--success);font-weight:500;">Paid</span>
        </div>
        <div class="info-row">
          <span class="info-label">Amount</span>
          <span class="info-value" style="color:var(--burnt);font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;">${{ order.total }}</span>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}