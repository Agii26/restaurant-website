{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Orders{% endblock %}
{% block breadcrumb %}Orders{% endblock %}

{% block content %}

<!-- ── TOP STATS ── -->
<div class="stat-grid" style="margin-bottom:1.5rem;">
  <div class="stat-card stat-primary">
    <div class="stat-label">Today's Revenue</div>
    <div class="stat-value">${{ today_revenue|floatformat:2 }}</div>
    <div class="stat-sub">{{ today_count }} order{{ today_count|pluralize }} today</div>
  </div>
  <div class="stat-card stat-alert">
    <div class="stat-label">Pending</div>
    <div class="stat-value">{{ counts.pending }}</div>
    <div class="stat-sub">awaiting confirmation</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">In Progress</div>
    <div class="stat-value">{{ counts.preparing }}</div>
    <div class="stat-sub">being prepared</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Ready</div>
    <div class="stat-value">{{ counts.ready }}</div>
    <div class="stat-sub">for pickup</div>
  </div>
</div>

<!-- ── FILTERS ── -->
<div class="dash-card" style="margin-bottom:1rem;">
  <div class="dash-card-header">
    <span class="dash-card-title">All Orders</span>
    <span class="dash-card-title" style="color:var(--mid);font-size:0.68rem;">{{ orders|length }} result{{ orders|length|pluralize }}</span>
  </div>

  <!-- Status tabs -->
  <div class="status-tabs">
    <a href="{% url 'dashboard:orders_list' %}{% if date_filter %}?date={{ date_filter }}{% endif %}" class="status-tab {% if not status_filter %}active{% endif %}">
      All <span class="tab-count">{{ counts.all }}</span>
    </a>
    <a href="?status=pending{% if date_filter %}&date={{ date_filter }}{% endif %}" class="status-tab {% if status_filter == 'pending' %}active{% endif %}">
      Pending <span class="tab-count">{{ counts.pending }}</span>
    </a>
    <a href="?status=confirmed{% if date_filter %}&date={{ date_filter }}{% endif %}" class="status-tab {% if status_filter == 'confirmed' %}active{% endif %}">
      Confirmed <span class="tab-count">{{ counts.confirmed }}</span>
    </a>
    <a href="?status=preparing{% if date_filter %}&date={{ date_filter }}{% endif %}" class="status-tab {% if status_filter == 'preparing' %}active{% endif %}">
      Preparing <span class="tab-count">{{ counts.preparing }}</span>
    </a>
    <a href="?status=ready{% if date_filter %}&date={{ date_filter }}{% endif %}" class="status-tab {% if status_filter == 'ready' %}active{% endif %}">
      Ready <span class="tab-count">{{ counts.ready }}</span>
    </a>
    <a href="?status=completed{% if date_filter %}&date={{ date_filter }}{% endif %}" class="status-tab {% if status_filter == 'completed' %}active{% endif %}">
      Completed <span class="tab-count">{{ counts.completed }}</span>
    </a>
    <a href="?status=cancelled{% if date_filter %}&date={{ date_filter }}{% endif %}" class="status-tab {% if status_filter == 'cancelled' %}active{% endif %}">
      Cancelled <span class="tab-count">{{ counts.cancelled }}</span>
    </a>
  </div>

  <!-- Search + date filter -->
  <div class="filter-bar">
    <form method="GET" class="filter-form">
      {% if status_filter %}
        <input type="hidden" name="status" value="{{ status_filter }}">
      {% endif %}
      <input type="text" name="search" placeholder="Search name, email, order #..." value="{{ search }}" class="filter-input">
      <input type="date" name="date" value="{{ date_filter }}" class="filter-input filter-date">
      <button type="submit" class="filter-btn">Filter</button>
      {% if search or date_filter %}
        <a href="?{% if status_filter %}status={{ status_filter }}{% endif %}" class="filter-clear">Clear</a>
      {% endif %}
    </form>
  </div>

  <!-- Orders table -->
  {% if orders %}
    <div class="orders-table-wrap">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Pickup</th>
            <th>Placed</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
            <tr>
              <td class="order-num-cell">#{{ order.order_number|stringformat:"s"|slice:":8"|upper }}</td>
              <td>
                <div class="customer-cell">
                  <span class="customer-name">{{ order.name }}</span>
                  <span class="customer-email">{{ order.email }}</span>
                </div>
              </td>
              <td class="items-cell">{{ order.items.count }} item{{ order.items.count|pluralize }}</td>
              <td class="total-cell">${{ order.total }}</td>
              <td class="pickup-cell">{{ order.pickup_time|date:"M j" }} {{ order.pickup_time|time:"g:i A" }}</td>
              <td class="pickup-cell">{{ order.created_at|date:"M j, g:i A" }}</td>
              <td><span class="status-pill status-{{ order.status }}">{{ order.get_status_display }}</span></td>
              <td>
                <a href="{% url 'dashboard:order_detail' order.id %}" class="tbl-btn">View →</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="dash-empty">No orders found{% if search %} for "{{ search }}"{% endif %}.</div>
  {% endif %}

</div>

{% endblock %}