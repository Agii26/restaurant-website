<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Our Menu</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --cream: #f5f2ec;
      --warm-white: #faf8f4;
      --dark: #1c1a17;
      --mid: #6b6560;
      --light-border: #e2ddd6;
      --accent: #8b6f47;
      --accent-light: #c4a882;
    }

    body {
      font-family: 'Jost', sans-serif;
      background: var(--warm-white);
      color: var(--dark);
      font-weight: 300;
    }

    /* ── Header ── */
    header {
      text-align: center;
      padding: 4rem 1rem 2.5rem;
      border-bottom: 1px solid var(--light-border);
      background: var(--warm-white);
    }
    .header-eyebrow {
      font-family: 'Jost', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 0.8rem;
    }
    header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(3rem, 6vw, 5rem);
      font-weight: 300;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--dark);
      line-height: 1;
    }
    header p {
      margin-top: 1rem;
      color: var(--mid);
      font-size: 0.85rem;
      letter-spacing: 0.08em;
    }

    /* ── Category Nav ── */
    nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0;
      padding: 0;
      background: var(--warm-white);
      border-bottom: 1px solid var(--light-border);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    nav a {
      text-decoration: none;
      color: var(--mid);
      font-size: 0.72rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 1.1rem 1.6rem;
      border-right: 1px solid var(--light-border);
      transition: all 0.2s;
      position: relative;
    }
    nav a:first-child { border-left: 1px solid var(--light-border); }
    nav a::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 2px;
      background: var(--accent);
      transform: scaleX(0);
      transition: transform 0.2s;
    }
    nav a:hover { color: var(--dark); }
    nav a:hover::after { transform: scaleX(1); }

    /* ── Main Content ── */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 2rem 10rem;
    }

    /* ── Category Section ── */
    .category { margin-bottom: 5rem; }

    .category-header {
      display: flex;
      align-items: baseline;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--light-border);
    }
    .category-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 400;
      font-style: italic;
      color: var(--dark);
      letter-spacing: 0.02em;
    }
    .category-desc {
      font-size: 0.8rem;
      color: var(--mid);
      letter-spacing: 0.06em;
    }

    /* ── Items Grid ── */
    .items-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2.5rem 2rem;
    }
    @media (max-width: 900px) {
      .items-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 560px) {
      .items-grid { grid-template-columns: 1fr; }
    }

    /* ── Item Card ── */
    .item-card { display: flex; flex-direction: column; }

    .item-image-wrap {
      position: relative;
      width: 100%;
      padding-top: 70%;
      overflow: hidden;
      background: var(--cream);
      margin-bottom: 1rem;
    }
    .item-image-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    .item-card:hover .item-image-wrap img { transform: scale(1.04); }

    .item-no-image {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-light);
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.8rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .item-tags {
      position: absolute;
      top: 0.6rem;
      left: 0.6rem;
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }
    .tag {
      font-size: 0.65rem;
      padding: 0.15rem 0.5rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--dark);
      color: var(--warm-white);
    }
    .tag-featured { background: var(--accent); }

    .item-body { flex: 1; display: flex; flex-direction: column; }

    .item-name-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .item-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.15rem;
      font-weight: 500;
      color: var(--dark);
      text-decoration: none;
      letter-spacing: 0.02em;
      transition: color 0.2s;
    }
    .item-name:hover { color: var(--accent); }
    .item-price {
      font-size: 0.9rem;
      color: var(--mid);
      white-space: nowrap;
      font-weight: 400;
    }

    .item-desc {
      font-size: 0.82rem;
      color: var(--mid);
      line-height: 1.6;
      margin-bottom: 0.8rem;
      flex: 1;
    }

    .item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      padding-top: 0.8rem;
      border-top: 1px solid var(--light-border);
    }

    .item-addons-note {
      font-size: 0.72rem;
      color: var(--accent-light);
      letter-spacing: 0.06em;
    }

    .btn-add {
      background: none;
      border: none;
      border-bottom: 1px solid var(--dark);
      padding: 0.1rem 0;
      font-family: 'Jost', sans-serif;
      font-size: 0.72rem;
      font-weight: 400;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--dark);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-add:hover { color: var(--accent); border-color: var(--accent); }
    .btn-add.added { color: #4a7c59; border-color: #4a7c59; }
    .btn-add:disabled { color: var(--mid); border-color: var(--light-border); cursor: not-allowed; }

    .unavailable-tag {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--mid);
    }

    /* ── Addon Modal ── */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(28,26,23,0.5);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--warm-white);
      padding: 2.5rem;
      width: 100%;
      max-width: 400px;
      margin: 1rem;
    }
    .modal-eyebrow {
      font-size: 0.68rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }
    .modal h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 0.3rem;
    }
    .modal-price { font-size: 0.85rem; color: var(--mid); margin-bottom: 2rem; }
    .modal-label {
      display: block;
      font-size: 0.68rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--mid);
      margin-bottom: 0.5rem;
      margin-top: 1.2rem;
    }
    .modal select, .modal input[type="number"] {
      width: 100%;
      padding: 0.65rem 0.8rem;
      border: 1px solid var(--light-border);
      background: var(--warm-white);
      font-family: 'Jost', sans-serif;
      font-size: 0.9rem;
      font-weight: 300;
      color: var(--dark);
      appearance: none;
    }
    .modal select:focus, .modal input:focus { outline: 1px solid var(--accent); }
    .modal-actions { display: flex; gap: 0.8rem; margin-top: 2rem; }
    .btn-modal-confirm {
      flex: 1; padding: 0.8rem;
      background: var(--dark); color: var(--warm-white);
      border: none; font-family: 'Jost', sans-serif;
      font-size: 0.75rem; letter-spacing: 0.18em;
      text-transform: uppercase; cursor: pointer; transition: background 0.2s;
    }
    .btn-modal-confirm:hover { background: var(--accent); }
    .btn-modal-cancel {
      padding: 0.8rem 1.2rem;
      background: none; color: var(--mid);
      border: 1px solid var(--light-border);
      font-family: 'Jost', sans-serif;
      font-size: 0.75rem; letter-spacing: 0.15em;
      text-transform: uppercase; cursor: pointer;
    }
    .btn-modal-cancel:hover { background: var(--cream); }

    /* ── Cart Drawer ── */
    .cart-drawer {
      position: fixed;
      bottom: 0; right: 0;
      width: 340px;
      z-index: 200;
      background: var(--warm-white);
      border: 1px solid var(--light-border);
      border-bottom: none;
      box-shadow: -4px -4px 24px rgba(28,26,23,0.08);
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cart-drawer.open { transform: translateY(0); }

    .drawer-handle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      cursor: pointer;
      border-bottom: 1px solid var(--light-border);
      background: var(--dark);
      color: var(--warm-white);
      user-select: none;
    }
    .drawer-handle-left {
      display: flex; align-items: center; gap: 0.8rem;
    }
    .drawer-label {
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }
    .drawer-badge {
      background: var(--accent);
      color: var(--warm-white);
      font-size: 0.65rem;
      font-weight: 500;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }
    .drawer-handle-right {
      display: flex; align-items: center; gap: 0.8rem;
    }
    .drawer-subtotal-label {
      font-size: 0.8rem;
      color: #aaa;
    }
    .drawer-chevron {
      font-size: 0.7rem;
      color: #aaa;
      transition: transform 0.3s;
    }
    .cart-drawer.collapsed .drawer-chevron { transform: rotate(180deg); }

    .drawer-body {
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 400px;
    }
    .cart-drawer.collapsed .drawer-body { max-height: 0; }

    .drawer-items {
      max-height: 240px;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    .drawer-items::-webkit-scrollbar { width: 3px; }
    .drawer-items::-webkit-scrollbar-track { background: transparent; }
    .drawer-items::-webkit-scrollbar-thumb { background: var(--light-border); }

    .drawer-item {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      padding: 0.65rem 1.2rem;
      border-bottom: 1px solid #f0ece4;
    }
    .drawer-item:last-child { border-bottom: none; }
    .drawer-item-info { flex: 1; min-width: 0; }
    .drawer-item-name {
      font-size: 0.88rem;
      color: var(--dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .drawer-item-addon {
      font-size: 0.75rem;
      color: var(--accent-light);
      margin-top: 0.1rem;
    }
    .drawer-item-qty {
      font-size: 0.75rem;
      color: var(--mid);
      white-space: nowrap;
    }
    .drawer-item-price {
      font-size: 0.85rem;
      color: var(--dark);
      white-space: nowrap;
    }

    .drawer-footer {
      padding: 1rem 1.2rem;
      border-top: 1px solid var(--light-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--cream);
    }
    .drawer-total {
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--mid);
    }
    .drawer-total strong { color: var(--dark); font-weight: 500; }
    .btn-go-cart {
      font-family: 'Jost', sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--warm-white);
      background: var(--dark);
      text-decoration: none;
      padding: 0.6rem 1rem;
      transition: background 0.2s;
      border: none; cursor: pointer;
    }
    .btn-go-cart:hover { background: var(--accent); }

    /* ── Toast ── */
    .toast {
      position: fixed;
      top: 1.5rem; left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: var(--dark); color: var(--warm-white);
      padding: 0.6rem 1.4rem;
      font-size: 0.8rem; letter-spacing: 0.06em;
      opacity: 0; pointer-events: none;
      transition: all 0.3s ease; z-index: 400;
      white-space: nowrap;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .empty { text-align: center; color: var(--mid); padding: 5rem 0; font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-style: italic; }
  </style>
</head>
<body>

<header>
  <div class="header-eyebrow">Est. 2024</div>
  <h1>Our Menu</h1>
  <p>Fresh ingredients, crafted with care</p>
</header>

{% if categories %}
<nav>
  {% for category in categories %}
    <a href="#{{ category.slug }}">{{ category.name }}</a>
  {% endfor %}
</nav>
{% endif %}

<main>
  {% if categories %}
    {% for category in categories %}
      <section class="category" id="{{ category.slug }}">
        <div class="category-header">
          <h2 class="category-title">{{ category.name }}</h2>
          {% if category.description %}
            <span class="category-desc">{{ category.description }}</span>
          {% endif %}
        </div>

        <div class="items-grid">
          {% for item in category.items.all %}
            <div class="item-card">

              <div class="item-image-wrap">
                {% if item.image %}
                  <img src="{{ item.image.url }}" alt="{{ item.name }}" loading="lazy" />
                {% else %}
                  <div class="item-no-image">No image</div>
                {% endif %}

                <div class="item-tags">
                  {% if item.is_featured %}<span class="tag tag-featured">Featured</span>{% endif %}
                  {% for tag in item.tags.all %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </div>
              </div>

              <div class="item-body">
                <div class="item-name-row">
                  <a href="{% url 'menu:dish_detail' item.slug %}" class="item-name">{{ item.name }}</a>
                  <span class="item-price">${{ item.price }}</span>
                </div>

                {% if item.description %}
                  <p class="item-desc">{{ item.description|truncatewords:18 }}</p>
                {% endif %}

                <div class="item-footer">
                  <span class="item-addons-note">
                    {% if item.addons.all %}Add-ons available{% endif %}
                  </span>
                  {% if item.is_available %}
                    <button
                      class="btn-add"
                      data-item-id="{{ item.id }}"
                      data-item-name="{{ item.name }}"
                      data-item-price="{{ item.price }}"
                      data-has-addons="{% if item.addons.all %}true{% else %}false{% endif %}"
                      data-addons='[{% for a in item.addons.all %}{"id":{{ a.id }},"name":"{{ a.name }}","price":"{{ a.additional_price }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
                    >Add to Cart</button>
                  {% else %}
                    <span class="unavailable-tag">Unavailable</span>
                  {% endif %}
                </div>
              </div>

            </div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  {% else %}
    <p class="empty">Menu coming soon.</p>
  {% endif %}
</main>

<!-- Addon Modal -->
<div class="modal-overlay" id="addonModal">
  <div class="modal">
    <div class="modal-eyebrow">Customise</div>
    <h3 id="modalItemName"></h3>
    <p class="modal-price" id="modalItemPrice"></p>
    <label class="modal-label" for="modalAddon">Add-on</label>
    <select id="modalAddon">
      <option value="">No add-on</option>
    </select>
    <label class="modal-label" for="modalQty">Quantity</label>
    <input type="number" id="modalQty" value="1" min="1" max="20" />
    <div class="modal-actions">
      <button class="btn-modal-cancel" id="modalCancel">Cancel</button>
      <button class="btn-modal-confirm" id="modalConfirm">Add to Cart</button>
    </div>
  </div>
</div>

<!-- Cart Drawer (bottom-right) -->
<div class="cart-drawer" id="cartDrawer">
  <div class="drawer-handle" id="drawerHandle">
    <div class="drawer-handle-left">
      <span class="drawer-label">Your Order</span>
      <span class="drawer-badge" id="drawerCount">0</span>
    </div>
    <div class="drawer-handle-right">
      <span class="drawer-subtotal-label" id="drawerSubtotal">$0.00</span>
      <span class="drawer-chevron" id="drawerChevron">▲</span>
    </div>
  </div>
  <div class="drawer-body" id="drawerBody">
    <div class="drawer-items" id="drawerItems"></div>
    <div class="drawer-footer">
      <span class="drawer-total">Total <strong id="drawerTotal">$0.00</strong></span>
      <a href="{% url 'orders:cart' %}" class="btn-go-cart">View Full Cart</a>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  const CSRF = '{{ csrf_token }}';
  const DRAWER_KEY = 'cartDrawerCollapsed';
  let currentItemId = null;

  // ── Drawer state (persisted in localStorage) ──
  const drawer = document.getElementById('cartDrawer');
  const drawerBody = document.getElementById('drawerBody');

  function isCollapsed() {
    return localStorage.getItem(DRAWER_KEY) === 'true';
  }

  function setCollapsed(val) {
    localStorage.setItem(DRAWER_KEY, val ? 'true' : 'false');
    if (val) {
      drawer.classList.add('collapsed');
      document.getElementById('drawerChevron').textContent = '▲';
    } else {
      drawer.classList.remove('collapsed');
      document.getElementById('drawerChevron').textContent = '▼';
    }
  }

  // Restore saved state on load
  if (isCollapsed()) {
    drawer.classList.add('collapsed');
    document.getElementById('drawerChevron').textContent = '▲';
  }

  // Toggle on handle click — does NOT auto-expand when item added
  document.getElementById('drawerHandle').addEventListener('click', function () {
    setCollapsed(!isCollapsed());
  });

  // ── Toast ──
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
  }

  // ── Render drawer items ──
  function renderDrawer(data) {
    document.getElementById('drawerCount').textContent = data.cart_count;
    document.getElementById('drawerSubtotal').textContent = `$${data.cart_subtotal}`;
    document.getElementById('drawerTotal').textContent = `$${data.cart_subtotal}`;

    document.getElementById('drawerItems').innerHTML = data.cart_items.map(item => `
      <div class="drawer-item">
        <div class="drawer-item-info">
          <div class="drawer-item-name">${item.name}</div>
          ${item.addon_name ? `<div class="drawer-item-addon">+ ${item.addon_name}</div>` : ''}
        </div>
        <span class="drawer-item-qty">${item.quantity}×</span>
        <span class="drawer-item-price">$${item.total}</span>
      </div>
    `).join('');

    // Show drawer but DON'T override collapsed state
    drawer.classList.add('open');
  }

  // ── Add to cart (AJAX) ──
  function addToCart(itemId, addonId, quantity) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', CSRF);
    formData.append('quantity', quantity);
    if (addonId) formData.append('addon', addonId);

    fetch(`/orders/add/${itemId}/`, { method: 'POST', body: formData })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(`✓  ${data.added_item} added to order`);
          renderDrawer(data);

          const btn = document.querySelector(`[data-item-id="${itemId}"]`);
          if (btn) {
            const original = btn.textContent;
            btn.textContent = '✓ Added';
            btn.classList.add('added');
            setTimeout(() => {
              btn.textContent = original;
              btn.classList.remove('added');
            }, 1600);
          }
        }
      })
      .catch(() => showToast('Something went wrong. Please try again.'));
  }

  // ── Button click handlers ──
  document.querySelectorAll('.btn-add:not([disabled])').forEach(btn => {
    btn.addEventListener('click', function () {
      const itemId = this.dataset.itemId;
      const hasAddons = this.dataset.hasAddons === 'true';
      const addons = JSON.parse(this.dataset.addons || '[]');

      if (hasAddons) {
        currentItemId = itemId;
        document.getElementById('modalItemName').textContent = this.dataset.itemName;
        document.getElementById('modalItemPrice').textContent = `$${this.dataset.itemPrice}`;

        const select = document.getElementById('modalAddon');
        select.innerHTML = '<option value="">No add-on</option>';
        addons.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = `${a.name} (+$${a.price})`;
          select.appendChild(opt);
        });

        document.getElementById('modalQty').value = 1;
        document.getElementById('addonModal').classList.add('active');
      } else {
        addToCart(itemId, null, 1);
      }
    });
  });

  document.getElementById('modalConfirm').addEventListener('click', function () {
    const addonId = document.getElementById('modalAddon').value || null;
    const qty = parseInt(document.getElementById('modalQty').value) || 1;
    document.getElementById('addonModal').classList.remove('active');
    addToCart(currentItemId, addonId, qty);
  });

  document.getElementById('modalCancel').addEventListener('click', () => {
    document.getElementById('addonModal').classList.remove('active');
  });
  document.getElementById('addonModal').addEventListener('click', function (e) {
    if (e.target === this) this.classList.remove('active');
  });

  // ── Load existing cart on page load ──
  fetch('/orders/cart/count/')
    .then(r => r.json())
    .then(data => {
      if (data.count > 0) {
        document.getElementById('drawerCount').textContent = data.count;
        document.getElementById('drawerSubtotal').textContent = `$${data.subtotal}`;
        document.getElementById('drawerTotal').textContent = `$${data.subtotal}`;
        document.getElementById('drawerItems').innerHTML = data.cart_items.map(item => `
          <div class="drawer-item">
            <div class="drawer-item-info">
              <div class="drawer-item-name">${item.name}</div>
              ${item.addon_name ? `<div class="drawer-item-addon">+ ${item.addon_name}</div>` : ''}
            </div>
            <span class="drawer-item-qty">${item.quantity}×</span>
            <span class="drawer-item-price">$${item.total}</span>
          </div>
        `).join('');
        drawer.classList.add('open');
        // Restore collapsed state from localStorage
        if (isCollapsed()) {
          drawer.classList.add('collapsed');
          document.getElementById('drawerChevron').textContent = '▲';
        } else {
          document.getElementById('drawerChevron').textContent = '▼';
        }
      }
    })
    .catch(() => {});
</script>

</body>
</html>