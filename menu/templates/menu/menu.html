<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu — Warm Vibe Bistro</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/menu.css' %}">
</head>
<body>

<!-- NAV (matches home exactly) -->
<nav class="site-nav">
  <a href="/" class="nav-logo">Warm Vibe Bistro</a>
  <div class="nav-links">
    <a href="{% url 'menu:menu' %}">Menu</a>
    <a href="{% url 'reservations:reservation' %}">Reservations</a>
    <a href="/#about">About</a>
    <a href="/#hours">Hours</a>
    <a href="{% url 'orders:cart' %}" class="nav-cta">Cart</a>
  </div>
</nav>

<!-- PAGE HEADER -->
<div class="page-header">
  <div class="header-eyebrow">Warm Vibe Bistro</div>
  <h1>Our <em>Menu</em></h1>
  <p>Fresh ingredients, crafted with care</p>
</div>

<!-- CATEGORY NAV -->
{% if categories %}
<nav class="category-nav">
  {% for category in categories %}
    <a href="#{{ category.slug }}">{{ category.name }}</a>
  {% endfor %}
</nav>
{% endif %}

<!-- MENU ITEMS -->
<main>
  {% if categories %}
    {% for category in categories %}
      <section class="category" id="{{ category.slug }}">
        <div class="category-header">
          <div>
            <div class="section-tag">{{ forloop.counter|stringformat:"02d" }}</div>
            <h2 class="category-title">{{ category.name }}</h2>
          </div>
          {% if category.description %}
            <span class="category-desc">{{ category.description }}</span>
          {% endif %}
        </div>

        <div class="items-grid">
          {% for item in category.items.all %}
            <div class="item-card">

              <div class="item-image-wrap">
                {% if item.image %}
                  <img src="{{ item.image.url }}" alt="{{ item.name }}" loading="lazy" />
                {% else %}
                  <div class="item-no-image">No image yet</div>
                {% endif %}
                <div class="item-tags">
                  {% if item.is_featured %}<span class="tag tag-featured">Featured</span>{% endif %}
                  {% for tag in item.tags.all %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </div>
              </div>

              <div class="item-body">
                <div class="item-name-row">
                  <a href="{% url 'menu:dish_detail' item.slug %}" class="item-name">{{ item.name }}</a>
                  <span class="item-price">${{ item.price }}</span>
                </div>
                {% if item.description %}
                  <p class="item-desc">{{ item.description|truncatewords:18 }}</p>
                {% endif %}
                <div class="item-footer">
                  <span class="item-addons-note">
                    {% if item.addons.all %}Add-ons available{% endif %}
                  </span>
                  {% if item.is_available %}
                    <button
                      class="btn-add"
                      data-item-id="{{ item.id }}"
                      data-item-name="{{ item.name }}"
                      data-item-price="{{ item.price }}"
                      data-has-addons="{% if item.addons.all %}true{% else %}false{% endif %}"
                      data-addons='[{% for a in item.addons.all %}{"id":{{ a.id }},"name":"{{ a.name }}","price":"{{ a.additional_price }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
                    >Add to Cart</button>
                  {% else %}
                    <span class="unavailable-tag">Unavailable</span>
                  {% endif %}
                </div>
              </div>

            </div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  {% else %}
    <p class="empty">Menu coming soon.</p>
  {% endif %}
</main>

<!-- ADDON MODAL -->
<div class="modal-overlay" id="addonModal">
  <div class="modal">
    <div class="modal-eyebrow">Customise</div>
    <h3 id="modalItemName"></h3>
    <p class="modal-price" id="modalItemPrice"></p>
    <label class="modal-label" for="modalAddon">Add-on</label>
    <select id="modalAddon"><option value="">No add-on</option></select>
    <label class="modal-label" for="modalQty">Quantity</label>
    <input type="number" id="modalQty" value="1" min="1" max="20" />
    <div class="modal-actions">
      <button class="btn-modal-cancel" id="modalCancel">Cancel</button>
      <button class="btn-modal-confirm" id="modalConfirm">Add to Cart</button>
    </div>
  </div>
</div>

<!-- CART DRAWER -->
<div class="cart-drawer" id="cartDrawer">
  <div class="drawer-handle" id="drawerHandle">
    <div class="drawer-handle-left">
      <span class="drawer-label">Your Order</span>
      <span class="drawer-badge" id="drawerCount">0</span>
    </div>
    <div class="drawer-handle-right">
      <span class="drawer-subtotal-label" id="drawerSubtotal">$0.00</span>
      <span class="drawer-chevron" id="drawerChevron">▲</span>
    </div>
  </div>
  <div class="drawer-body">
    <div class="drawer-items" id="drawerItems"></div>
    <div class="drawer-footer">
      <span class="drawer-total">Total <strong id="drawerTotal">$0.00</strong></span>
      <a href="{% url 'orders:cart' %}" class="btn-go-cart">View Full Cart</a>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
  const CSRF = '{{ csrf_token }}';
  const DRAWER_KEY = 'cartDrawerCollapsed';
  let currentItemId = null;
  const drawer = document.getElementById('cartDrawer');

  function isCollapsed() { return localStorage.getItem(DRAWER_KEY) === 'true'; }
  function setCollapsed(val) {
    localStorage.setItem(DRAWER_KEY, val ? 'true' : 'false');
    drawer.classList.toggle('collapsed', val);
    document.getElementById('drawerChevron').textContent = val ? '▲' : '▼';
  }

  if (isCollapsed()) {
    drawer.classList.add('collapsed');
    document.getElementById('drawerChevron').textContent = '▲';
  }

  document.getElementById('drawerHandle').addEventListener('click', () => setCollapsed(!isCollapsed()));

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
  }

  function renderDrawer(data) {
    document.getElementById('drawerCount').textContent = data.cart_count;
    document.getElementById('drawerSubtotal').textContent = `$${data.cart_subtotal}`;
    document.getElementById('drawerTotal').textContent = `$${data.cart_subtotal}`;
    document.getElementById('drawerItems').innerHTML = data.cart_items.map(item => `
      <div class="drawer-item">
        <div class="drawer-item-info">
          <div class="drawer-item-name">${item.name}</div>
          ${item.addon_name ? `<div class="drawer-item-addon">+ ${item.addon_name}</div>` : ''}
        </div>
        <span class="drawer-item-qty">${item.quantity}×</span>
        <span class="drawer-item-price">$${item.total}</span>
      </div>
    `).join('');
    drawer.classList.add('open');
  }

  function addToCart(itemId, addonId, quantity) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', CSRF);
    formData.append('quantity', quantity);
    if (addonId) formData.append('addon', addonId);

    fetch(`/orders/add/${itemId}/`, { method: 'POST', body: formData })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(`✓  ${data.added_item} added to order`);
          renderDrawer(data);
          const btn = document.querySelector(`[data-item-id="${itemId}"]`);
          if (btn) {
            btn.textContent = '✓ Added';
            btn.classList.add('added');
            setTimeout(() => { btn.textContent = 'Add to Cart'; btn.classList.remove('added'); }, 1600);
          }
        }
      })
      .catch(() => showToast('Something went wrong. Please try again.'));
  }

  document.querySelectorAll('.btn-add:not([disabled])').forEach(btn => {
    btn.addEventListener('click', function () {
      const itemId = this.dataset.itemId;
      const hasAddons = this.dataset.hasAddons === 'true';
      const addons = JSON.parse(this.dataset.addons || '[]');
      if (hasAddons) {
        currentItemId = itemId;
        document.getElementById('modalItemName').textContent = this.dataset.itemName;
        document.getElementById('modalItemPrice').textContent = `$${this.dataset.itemPrice}`;
        const select = document.getElementById('modalAddon');
        select.innerHTML = '<option value="">No add-on</option>';
        addons.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = `${a.name} (+$${a.price})`;
          select.appendChild(opt);
        });
        document.getElementById('modalQty').value = 1;
        document.getElementById('addonModal').classList.add('active');
      } else {
        addToCart(itemId, null, 1);
      }
    });
  });

  document.getElementById('modalConfirm').addEventListener('click', function () {
    const addonId = document.getElementById('modalAddon').value || null;
    const qty = parseInt(document.getElementById('modalQty').value) || 1;
    document.getElementById('addonModal').classList.remove('active');
    addToCart(currentItemId, addonId, qty);
  });
  document.getElementById('modalCancel').addEventListener('click', () => {
    document.getElementById('addonModal').classList.remove('active');
  });
  document.getElementById('addonModal').addEventListener('click', function (e) {
    if (e.target === this) this.classList.remove('active');
  });

  // Load existing cart on page load
  fetch('/orders/cart/count/')
    .then(r => r.json())
    .then(data => {
      if (data.count > 0) {
        document.getElementById('drawerCount').textContent = data.count;
        document.getElementById('drawerSubtotal').textContent = `$${data.subtotal}`;
        document.getElementById('drawerTotal').textContent = `$${data.subtotal}`;
        document.getElementById('drawerItems').innerHTML = data.cart_items.map(item => `
          <div class="drawer-item">
            <div class="drawer-item-info">
              <div class="drawer-item-name">${item.name}</div>
              ${item.addon_name ? `<div class="drawer-item-addon">+ ${item.addon_name}</div>` : ''}
            </div>
            <span class="drawer-item-qty">${item.quantity}×</span>
            <span class="drawer-item-price">$${item.total}</span>
          </div>
        `).join('');
        drawer.classList.add('open');
        if (isCollapsed()) {
          drawer.classList.add('collapsed');
          document.getElementById('drawerChevron').textContent = '▲';
        } else {
          document.getElementById('drawerChevron').textContent = '▼';
        }
      }
    })
    .catch(() => {});
</script>

</body>
</html>